<!doctype html>
<html>
	<head>
		<style>
			.lds-ripple {
			  display: inline-block;
			  position: relative;
			  width: 80px;
			  height: 80px;
			}
			.lds-ripple div {
			  position: absolute;
			  border: 4px solid #fff;
			  opacity: 1;
			  border-radius: 50%;
			  animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
			}
			.lds-ripple div:nth-child(2) {
			  animation-delay: -0.5s;
			}
			@keyframes lds-ripple {
			  0% {
				top: 36px;
				left: 36px;
				width: 0;
				height: 0;
				opacity: 0;
			  }
			  4.9% {
				top: 36px;
				left: 36px;
				width: 0;
				height: 0;
				opacity: 0;
			  }
			  5% {
				top: 36px;
				left: 36px;
				width: 0;
				height: 0;
				opacity: 1;
			  }
			  100% {
				top: 0px;
				left: 0px;
				width: 72px;
				height: 72px;
				opacity: 0;
			  }
			}
			
			.loader{
				position:fixed;
				top:0;
				z-index:80;
				width:100%;
				height:100%;
				display:flex;
				justify-content:center;
				align-items:center;
				background-color:rgba(0,0,0,0.5);
			}
		</style>
	
		<style>
			html {
				height: -webkit-fill-available;
			}
		
			body{
				width:100%; height:100%;
				background-color:#000;
				color:#fff;
				padding:0;margin:0;
				font-family:sans-serif;
				overflow:hidden;
			}
			
			.d-none{
				display:none !important;
			}
			
			.content{
				display:flex;
				justify-content:center;
			}
			
			.animevideo{
				height:100vh;
			}
			
			.information{
				position:fixed;
				bottom:0;
				z-index:50;
				background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.8) 40%, rgba(0,0,0,0) 60%);
				width:100%;
				padding:30px;
				display:flex;
				flex-direction:row;
			}	
			
			.animeTitle{
				display:flex;
				flex-direction:column;
			}
			
			.animename{
				font-size:5vh;
			}
			
			.song, .year{
				padding:10px 0;
				font-size:2vh;
				color:#CCC;
			}
			
			.settings{
				font-size:2vh;
				position:fixed;
				z-index:100;
				width:100%;
				height:100%;
				background-color:hsl(290, 50%, 80%);
				display:flex;
				justify-content:center;
				flex-direction:column;
				align-items:center;
				transition:transform 2s;
			}
			
			.blinder{
				pointer-events: none;
				background-color:hsl(180, 50%, 50%);
				top:0;
				position:fixed;
				z-index:75;
				width:100%;
				height:100%;
				display:flex;
				justify-content:center;
				align-items:center;
				font-size:25vh;
				filter:opacity(100);
				transition: filter 1s, background-color 1s;
			}
			
			h1{
				margin:0;
			}
			
			button{
				background-color:transparent;
				border:2px solid #FFF;
				border-radius:2vw;
				padding:10px 32px;
				font-size:2vh;
				color:#FFF;
				margin:10px;
			}
			
			button:hover{
				background-color:rgba(128,0,0,0.1);
				cursor:pointer;
			}
			
			button[disabled]{
				background-color:#DDD;
				cursor:not-allowed;
			}
			
			.np{
				z-index:80;
				background-color:rgba(255,255,255,0);
				position:fixed;
				
				height:100%;
				width:2%;
				
				padding:10px;
				display:flex;
				align-items:center;
				justify-content:center;
				color:#FFF;
				font-size:32px;
				transition:background-color 1s;
				cursor:pointer;
			}
			
			.next{
				top:0;right:0;
			}
			
			.precedent{
				top:0;left:0;
				height:auto;width:auto;
				padding:10px;
			}
			
			.np:hover{
				background-color:rgba(255,255,255,0.2);
			}
			
			input, select{
				background-color:transparent;
				border:none;
				border-bottom:2px solid #FFF;
				color:#FFF;
				font-size:2vh;
				text-align:center;
			}
			input:focus, select:focus{
				outline:none;
			}
			
			select{
				width:100%;
			}
			select option{
				background-color:hsl(290, 50%, 80%);
			}
			table {
			  border-collapse: collapse;
			  width: 100%;
			}

			th, td {
			  text-align: left;
			  padding: 8px;
			}

			tr:nth-child(even){background-color: rgba(255,255,255,0.5)}

			th {
			  background-color: rgba(128,0,0,0.1);
			  color: white;
			  text-align:center;
			}
			
			.labeledForm{
				display:grid;
				grid-template-columns:1fr 1fr 20px;
				margin:20px 0;
			}
			
		</style>
		<title>Infinite Anime Blindtest</title>
		<meta charset="utf-8">
		<meta property="og:site_name" content="ShannonEgoiste">		
		<meta property="og:url" content="https://shannonegoiste.github.io/InfiniteBlindtest/">		
		<meta property="og:title" content="Infinite Blindtest">		
	</head>
	<body>
		<div class="loader d-none"><div class="lds-ripple"><div></div><div></div></div></div>
		<div class="settings">
			<div class="settingsBlindTest">
				<h1>Infinite Anime BlindTest</h1>
				<div style="font-size:2vh;color:rgba(255,255,255,0.7)">Made by&nbsp;<a style="color:#FFFA;" href="https://twitter.com/EgoisteShannon">Shannon Egoiste</a></div>
				<hr style="width:100%;">
				<div class='labeledForm'><label for="blindDuration">Blind duration</label><input onchange="blindDuration =this.value" id="blindDuration" type="number" value="10"/>s</div>
				<div class='labeledForm'><label for="revealDuration">Reveal duration</label><input onchange="revealDuration = this.value" id="revealDuration"type="number" value="25"/>s</div>
				<hr style="width:100%;">
				<div class='labeledForm'><label for="listMode">Theme list</label><select id="listMode" onchange="listSelection(this.value);">
					<option value="rand" selected>Random</option>
					<option value="t100">100 Most Popular MAL</option>
					<option value="gund">Gundam</option>
					<select/>
				</div>
				<div class='labeledForm'><label for="themeMode">Theme mode</label><select id="themeMode"><option value="OP" selected>Opening</option><option value="ED">Ending</option><option value="--">Both</option><select/></div>
				<div id="yearArea">from year <input id="startYear" value="1963"/> to <input id="endYear" value="2023"/></div>
				<hr style="width:100%;">
				<button style="width:100%;" onclick="launchBlindtest()" class="startButton">start</button>
				<hr class="resumeBlindTest d-none">
				<div class="resumeBlindTest d-none" style="max-height:256px;overflow-y:scroll">
					<table>
						<thead>
							<tr><th colspan="2">BlindTestHistory</th></tr>
							<tr><th>anime op</th><th>link</th></tr>
						</thead>
						<tbody class="history"></tbody>
					</table>
				</div>
				<hr class="resumeBlindTest d-none">
				<button class="resumeBlindTest d-none" style="width:100%;" onclick="resumeBlindTest()">Resume</button>
			</div>
			
			<div style="position:fixed;bottom:0px;left:0px;margin:10px;">
				video and data come from <a href="https://animethemes.moe/">animethemes.moe</a> awesome API 
			</div>
		</div>
		<div class="content" onclick="video.paused?video.play():video.pause()">
			<video class="animevideo" autoplay></video>	
		</div>
		<div class="information">
			<div class="animeTitle">
				<span class="animename"></span>
				<div style="display:flex;flex-direction:row;"><span class="year"></span><div style="border:1px solid #FFF;margin:10px"></div><span class="song"></span></div>
			</div>
		</div>
		<div class="precedent np" onclick="openSettings()" >
			<svg fill="#ffffff" height="20px" width="20px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 478.703 478.703" xml:space="preserve" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M454.2,189.101l-33.6-5.7c-3.5-11.3-8-22.2-13.5-32.6l19.8-27.7c8.4-11.8,7.1-27.9-3.2-38.1l-29.8-29.8 c-5.6-5.6-13-8.7-20.9-8.7c-6.2,0-12.1,1.9-17.1,5.5l-27.8,19.8c-10.8-5.7-22.1-10.4-33.8-13.9l-5.6-33.2 c-2.4-14.3-14.7-24.7-29.2-24.7h-42.1c-14.5,0-26.8,10.4-29.2,24.7l-5.8,34c-11.2,3.5-22.1,8.1-32.5,13.7l-27.5-19.8 c-5-3.6-11-5.5-17.2-5.5c-7.9,0-15.4,3.1-20.9,8.7l-29.9,29.8c-10.2,10.2-11.6,26.3-3.2,38.1l20,28.1 c-5.5,10.5-9.9,21.4-13.3,32.7l-33.2,5.6c-14.3,2.4-24.7,14.7-24.7,29.2v42.1c0,14.5,10.4,26.8,24.7,29.2l34,5.8 c3.5,11.2,8.1,22.1,13.7,32.5l-19.7,27.4c-8.4,11.8-7.1,27.9,3.2,38.1l29.8,29.8c5.6,5.6,13,8.7,20.9,8.7c6.2,0,12.1-1.9,17.1-5.5 l28.1-20c10.1,5.3,20.7,9.6,31.6,13l5.6,33.6c2.4,14.3,14.7,24.7,29.2,24.7h42.2c14.5,0,26.8-10.4,29.2-24.7l5.7-33.6 c11.3-3.5,22.2-8,32.6-13.5l27.7,19.8c5,3.6,11,5.5,17.2,5.5l0,0c7.9,0,15.3-3.1,20.9-8.7l29.8-29.8c10.2-10.2,11.6-26.3,3.2-38.1 l-19.8-27.8c5.5-10.5,10.1-21.4,13.5-32.6l33.6-5.6c14.3-2.4,24.7-14.7,24.7-29.2v-42.1 C478.9,203.801,468.5,191.501,454.2,189.101z M451.9,260.401c0,1.3-0.9,2.4-2.2,2.6l-42,7c-5.3,0.9-9.5,4.8-10.8,9.9 c-3.8,14.7-9.6,28.8-17.4,41.9c-2.7,4.6-2.5,10.3,0.6,14.7l24.7,34.8c0.7,1,0.6,2.5-0.3,3.4l-29.8,29.8c-0.7,0.7-1.4,0.8-1.9,0.8 c-0.6,0-1.1-0.2-1.5-0.5l-34.7-24.7c-4.3-3.1-10.1-3.3-14.7-0.6c-13.1,7.8-27.2,13.6-41.9,17.4c-5.2,1.3-9.1,5.6-9.9,10.8l-7.1,42 c-0.2,1.3-1.3,2.2-2.6,2.2h-42.1c-1.3,0-2.4-0.9-2.6-2.2l-7-42c-0.9-5.3-4.8-9.5-9.9-10.8c-14.3-3.7-28.1-9.4-41-16.8 c-2.1-1.2-4.5-1.8-6.8-1.8c-2.7,0-5.5,0.8-7.8,2.5l-35,24.9c-0.5,0.3-1,0.5-1.5,0.5c-0.4,0-1.2-0.1-1.9-0.8l-29.8-29.8 c-0.9-0.9-1-2.3-0.3-3.4l24.6-34.5c3.1-4.4,3.3-10.2,0.6-14.8c-7.8-13-13.8-27.1-17.6-41.8c-1.4-5.1-5.6-9-10.8-9.9l-42.3-7.2 c-1.3-0.2-2.2-1.3-2.2-2.6v-42.1c0-1.3,0.9-2.4,2.2-2.6l41.7-7c5.3-0.9,9.6-4.8,10.9-10c3.7-14.7,9.4-28.9,17.1-42 c2.7-4.6,2.4-10.3-0.7-14.6l-24.9-35c-0.7-1-0.6-2.5,0.3-3.4l29.8-29.8c0.7-0.7,1.4-0.8,1.9-0.8c0.6,0,1.1,0.2,1.5,0.5l34.5,24.6 c4.4,3.1,10.2,3.3,14.8,0.6c13-7.8,27.1-13.8,41.8-17.6c5.1-1.4,9-5.6,9.9-10.8l7.2-42.3c0.2-1.3,1.3-2.2,2.6-2.2h42.1 c1.3,0,2.4,0.9,2.6,2.2l7,41.7c0.9,5.3,4.8,9.6,10,10.9c15.1,3.8,29.5,9.7,42.9,17.6c4.6,2.7,10.3,2.5,14.7-0.6l34.5-24.8 c0.5-0.3,1-0.5,1.5-0.5c0.4,0,1.2,0.1,1.9,0.8l29.8,29.8c0.9,0.9,1,2.3,0.3,3.4l-24.7,34.7c-3.1,4.3-3.3,10.1-0.6,14.7 c7.8,13.1,13.6,27.2,17.4,41.9c1.3,5.2,5.6,9.1,10.8,9.9l42,7.1c1.3,0.2,2.2,1.3,2.2,2.6v42.1H451.9z"></path> <path d="M239.4,136.001c-57,0-103.3,46.3-103.3,103.3s46.3,103.3,103.3,103.3s103.3-46.3,103.3-103.3S296.4,136.001,239.4,136.001 z M239.4,315.601c-42.1,0-76.3-34.2-76.3-76.3s34.2-76.3,76.3-76.3s76.3,34.2,76.3,76.3S281.5,315.601,239.4,315.601z"></path> </g> </g> </g></svg>
		</div>
		<div class="next np" onclick="nextAnime()">›</div>
		
		
		
		<div class="blinder">
			<div class="blindCounter">
				10
			</div>
		</div>
		
		<script>
			fetch("https://api.animethemes.moe/animeyear/").then((res)=> res.json()).then((res)=>{
				document.querySelector("#startYear").value = starYear =res[0];
				document.querySelector("#endYear").value = endYear = res[res.length-1];				
			});
		
		</script>
	
		<script>
			var baseURL = "https://api.animethemes.moe/anime?";
			var listParameter = [
				"include=animethemes.animethemeentries.videos,animethemes.song.artists",
				"fields[anime]=name,year",
				"page[size]=1",
				"sort=random"
			];
			var type = "";
			var constructedURL = "";
			var revealDuration = 0;
			var blindDuration = 0;
			var startYear = 0;
			var endYear = 0;
			var gameList;
			var listAnime = []; 
			//byPopularity();
			//gundam();
			
			function listSelection(v){
				;
				document.querySelector("#themeMode").value = "OP";
				if(v == "rand"){
					document.querySelector("#yearArea").classList.remove("d-none");
				}else{
					document.querySelector(".startButton").setAttribute("disabled",true);
					listAnime = [];
					if(v == "gund"){
						fetch("https://api.animethemes.moe/anime?fields[anime]=name&q=gundam&page[size]=100").then((res)=>res.json()).then((res)=>{
							listAnime = res.anime.map(x=>x.name);
							listAnime = listAnime.filter(x=>x.indexOf("undam")>0);
							document.querySelector(".startButton").removeAttribute("disabled");
						});
						document.querySelector("#themeMode").value = "--";
					}else if(v == "t100"){
						for(var i = 1; i <= 4; i++){
							fetch("https://api.jikan.moe/v4/top/anime?page="+i+"&filter=bypopularity&type=tv").then((res)=>{ return res.json();}).then((res)=>{
								listAnime = listAnime.concat(res.data.map(x=>x.title));
								document.querySelector(".startButton").removeAttribute("disabled");
							});				
						}
					}
					
					document.querySelector("#yearArea").classList.add("d-none");
				}
			}
			
			function launchBlindtest(){
				blindDuration = Number(document.querySelector("#blindDuration").value);
				revealDuration = blindDuration+Number(document.querySelector("#revealDuration").value);
				if(blindDuration == 0){
					document.querySelector(".blinder").classList.add("d-none");	
				}
				
				gameList = document.querySelector("#listMode").value;
				
						
				if(gameList == "rand"){ 				
					startYear = document.querySelector("#startYear").value;
					endYear = document.querySelector("#endYear").value;			
					listParameter.push("filter[year-gte-and]="+startYear);
					listParameter.push("filter[year-lte-and]="+endYear);
				}
				
				constructedURL = baseURL+listParameter.join("&");
				type = document.querySelector("#themeMode").value;
				document.querySelector(".settings").style.transform="translate(0,-100%)";
				nextAnime();
			}
			
			function resumeBlindTest(){
				document.querySelector(".settings").style.transform="translate(0,-100%)";
				video.play();
			}
			
			function openSettings(){
				document.querySelector(".settings").style.transform="translate(0,0)";
				document.querySelectorAll(".resumeBlindTest").forEach((elem)=>{elem.classList.remove("d-none");});
				video.pause();
			}

			function nextAnime(){
				video.currentTime = null;
				
				var ncURL = constructedURL;
				if(gameList != 'rand'){
					ncURL+="&q="+encodeURI(listAnime[Math.floor(Math.random() * listAnime.length)]);
				}

				document.querySelector(".blinder").style.filter = "opacity(100)";
				fetch(ncURL).then((res)=>{return res.json();}).then((res)=>{
					var anime = res.anime[0];
					if(type  == "OP" || type == "ED"){
						anime.animethemes = anime.animethemes.filter(function(elem){
							return elem.type == type;
						});						
						if(anime.animethemes.length == 0){
							console.log("%c can't find "+type+" for anime '"+anime.name+"'","color:#F00");
							nextAnime();
							return;
						}
					}
					anime.animethemes = anime.animethemes[Math.floor(Math.random() * anime.animethemes.length)];
					anime.animethemes = {
						"oped":anime.animethemes.slug,
						"title":anime.animethemes.song.title,
						"artist":anime.animethemes.song.artists.map(x=>x.name).join(", "),
						"link":anime.animethemes.animethemeentries[0].videos[0].basename
					}
					
					newTheme(anime);
				});
			}
			
			var video = document.querySelector(".animevideo");	
			
			var loadingverifier;
			video.addEventListener("timeupdate",function(){
				if(loadingverifier == video.currentTime || video.currentTime == 0){
					document.querySelector(".loader").classList.remove("d-none");
				}else{
					document.querySelector(".loader").classList.add("d-none");
				}			
				loadingverifier = video.currentTime;
				
				var displayedTime = "";
				
				if(video.currentTime > revealDuration || video.currentTime == video.duration){
					nextAnime();
				}else if(video.currentTime > revealDuration-1){
					document.querySelector(".blinder").style.filter = "opacity(100)";
				}else if(video.currentTime > blindDuration-1){
					document.querySelector(".blinder").style.filter = "opacity(0)";
				}else{
					displayedTime = Math.round(blindDuration-video.currentTime)
				}
				document.querySelector(".blindCounter").innerHTML = displayedTime;		
			});
			
			function newTheme(anime){
					document.querySelector(".blinder").style.backgroundColor="hsl("+Math.floor(Math.random() * 360)+", 50%, 50%)";
					document.querySelector(".loader").classList.remove("d-none");
					
					video.src = "https://v.animethemes.moe/"+anime.animethemes.link;
					
					document.querySelector(".animename").innerHTML = anime.name+(anime.animethemes.oped.length > 2?" - "+anime.animethemes.oped:"");
					document.querySelector(".year").innerHTML = "start airing in "+anime.year;
					document.querySelector(".song").innerHTML = "Song : "+(anime.animethemes.artist != ""?anime.animethemes.artist+" - ":"")+anime.animethemes.title;
					
					document.querySelector(".history").innerHTML+="<tr><td>"+anime.name+"</td><td><a href='"+video.src+"'>link</a></td></tr>";
			}
			
			document.addEventListener("wheel",function(e){
				var inc = (e.deltaY>0?-0.05:0.05);
				video.volume = Math.min(Math.max(0,video.volume+inc),1);
				
			});
		</script>
	</body>
</html>
